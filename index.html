<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Propostas - SUP BARREIRAS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root {
      --primary: #0f766e;
      --primary-dark: #0d5c54;
      --primary-light: #14b8a6;
      --secondary: #475569;
      --secondary-light: #64748b;
      --accent: #10b981;
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --border: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .btn {
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--bg-main);
    }
    
    .input {
      padding: 0.625rem 0.875rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      background: white;
      width: 100%;
    }
    
    .input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    thead th {
      padding: 0.875rem 0.75rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: white;
      white-space: nowrap;
    }
    
    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s ease;
    }
    
    tbody tr:hover {
      background: var(--bg-main);
    }
    
    tbody td {
      padding: 0.75rem;
      font-size: 0.875rem;
      color: var(--text-primary);
    }
    
    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: var(--primary);
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
      margin: 0.5rem 0;
    }
    
    .stat-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .filter-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .checkbox-group:hover {
      background: var(--bg-main);
    }
    
    .checkbox {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: var(--bg-main);
      border-radius: 4px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: var(--secondary-light);
      border-radius: 4px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }
    
    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .grid {
      display: grid;
      gap: 1.5rem;
    }
    
    .grid-cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .grid-cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }
    
    @media (max-width: 768px) {
      .grid-cols-2,
      .grid-cols-3,
      .grid-cols-4 {
        grid-template-columns: 1fr;
      }
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }
    
    .header h1 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 0.875rem;
    }
    
    .log-container {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
    }
    
    .log-entry {
      padding: 0.25rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-success { color: var(--accent); font-weight: 600; }
    .log-error { color: #dc2626; font-weight: 600; }
    .log-warning { color: #f59e0b; font-weight: 600; }
    .log-info { color: var(--primary); font-weight: 600; }
    
    .evolution-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.75rem;
    }
    
    .evolution-arrow {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .column-selector {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div style="max-width: 1600px; margin: 0 auto; padding: 2rem;">
    <!-- Header -->
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
          <h1>Painel de Propostas</h1>
          <p>SUP BARREIRAS ‚Ä¢ Sistema de An√°lise e Gest√£o de Propostas</p>
        </div>
        <label class="btn btn-primary" style="cursor: pointer;">
          <input id="fileInput" type="file" multiple accept=".xlsx" style="display: none;" />
          <i data-lucide="upload" style="width: 1.25rem; height: 1.25rem;"></i>
          <span>Carregar Planilhas</span>
        </label>
      </div>
    </div>

    <!-- Log -->
    <div id="logContainer" class="log-container hidden" style="margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
        <strong style="font-size: 0.875rem;">Log de Processamento</strong>
        <button id="clearLog" class="btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
          Limpar
        </button>
      </div>
      <div id="logContent"></div>
    </div>

    <!-- Cards de Resumo -->
    <div class="grid grid-cols-4" style="margin-bottom: 1.5rem;">
      <div class="stat-card">
        <div class="stat-label">Total de Propostas</div>
        <div id="statTotal" class="stat-value">0</div>
        <div style="font-size: 0.75rem; color: var(--text-secondary);">Filtradas</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Valor Total</div>
        <div id="statValor" class="stat-value" style="font-size: 1.5rem;">R$ 0</div>
        <div style="font-size: 0.75rem; color: var(--text-secondary);">Somado</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Novas</div>
        <div id="statNovas" class="stat-value">0</div>
        <div style="font-size: 0.75rem; color: var(--text-secondary);">Propostas</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Removidas</div>
        <div id="statRemovidas" class="stat-value">0</div>
        <div style="font-size: 0.75rem; color: var(--text-secondary);">Propostas</div>
      </div>
    </div>

    <!-- Filtros e Seletor de Colunas -->
    <div class="grid" style="grid-template-columns: 2fr 1fr; margin-bottom: 1.5rem;">
      <!-- Filtros -->
      <div class="filter-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 class="section-title" style="margin: 0;">
            <i data-lucide="filter" style="width: 1.25rem; height: 1.25rem;"></i>
            Filtros por Coluna
          </h2>
          <button id="clearFilters" class="btn-secondary" style="padding: 0.5rem 1rem;">
            <i data-lucide="x-circle" style="width: 1rem; height: 1rem;"></i>
            Limpar Filtros
          </button>
        </div>
        <div id="filtersContainer" class="grid grid-cols-3"></div>
      </div>

      <!-- Seletor de Colunas -->
      <div class="filter-section">
        <h2 class="section-title">
          <i data-lucide="columns" style="width: 1.25rem; height: 1.25rem;"></i>
          Colunas Vis√≠veis
        </h2>
        <div id="columnSelector" class="column-selector scrollbar-thin"></div>
      </div>
    </div>

    <!-- Controles de Visualiza√ß√£o e Exporta√ß√£o -->
    <div class="card" style="padding: 1rem; margin-bottom: 1.5rem;">
      <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">
            MODO DE VISUALIZA√á√ÉO
          </label>
          <select id="viewMode" class="input">
            <option value="all">Todas as Propostas</option>
            <option value="consolidated">Consolidado por Ag√™ncia</option>
          </select>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">
            FILTRAR POR AG√äNCIA
          </label>
          <select id="filterAgencia" class="input">
            <option value="">Todas as Ag√™ncias</option>
          </select>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
          <button id="btnExportCSV" class="btn btn-primary">
            <i data-lucide="download" style="width: 1rem; height: 1rem;"></i>
            CSV
          </button>
          <button id="btnExportPNG" class="btn btn-secondary">
            <i data-lucide="image" style="width: 1rem; height: 1rem;"></i>
            PNG
          </button>
        </div>
      </div>
    </div>

    <!-- Tabela Principal -->
    <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
      <h2 class="section-title">
        <i data-lucide="table" style="width: 1.25rem; height: 1.25rem;"></i>
        Base Atual de Propostas
      </h2>
      <div class="table-container scrollbar-thin" style="max-height: 600px; overflow: auto;">
        <table id="mainTable">
          <thead>
            <tr id="tableHead"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Pain√©is Adicionais -->
    <div class="grid grid-cols-3">
      <!-- Total por Ag√™ncia -->
      <div class="card" style="padding: 1.5rem;">
        <h2 class="section-title">
          <i data-lucide="building-2" style="width: 1.25rem; height: 1.25rem;"></i>
          Por Ag√™ncia
        </h2>
        <div class="table-container scrollbar-thin" style="max-height: 300px;">
          <table>
            <thead>
              <tr>
                <th>Ag√™ncia</th>
                <th style="text-align: center;">Qtd</th>
                <th style="text-align: right;">Valor</th>
              </tr>
            </thead>
            <tbody id="agenciaBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Situa√ß√£o por Ag√™ncia -->
      <div class="card" style="padding: 1.5rem;">
        <h2 class="section-title">
          <i data-lucide="pie-chart" style="width: 1.25rem; height: 1.25rem;"></i>
          Situa√ß√£o/Ag√™ncia
        </h2>
        <div class="table-container scrollbar-thin" style="max-height: 300px;">
          <table>
            <thead id="situacaoAgenciaHead"></thead>
            <tbody id="situacaoAgenciaBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Removidas -->
      <div class="card" style="padding: 1.5rem;">
        <h2 class="section-title">
          <i data-lucide="trash-2" style="width: 1.25rem; height: 1.25rem; color: #dc2626;"></i>
          <span style="color: #dc2626;">Removidas</span>
        </h2>
        <div class="table-container scrollbar-thin" style="max-height: 300px;">
          <table>
            <thead>
              <tr>
                <th>Proposta</th>
                <th>Cliente</th>
                <th style="text-align: right;">Valor</th>
              </tr>
            </thead>
            <tbody id="removidasBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();
    
    // === LOG SYSTEM ===
    const logContainer = document.getElementById("logContainer");
    const logContent = document.getElementById("logContent");
    const clearLog = document.getElementById("clearLog");
    
    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logContent.appendChild(entry);
      logContainer.classList.remove('hidden');
      logContent.scrollTop = logContent.scrollHeight;
    }
    
    clearLog.addEventListener('click', () => {
      logContent.innerHTML = '';
      logContainer.classList.add('hidden');
    });
    
    // === GLOBAL STATE ===
    let datasets = [];
    let latestIndex = -1;
    let latestRows = [];
    let proposalHistory = {};
    let removedProposals = [];
    let columnMapping = {};
    let allColumns = [];
    let visibleColumns = new Set();
    let columnFilters = {};
    
    // === COLUMN DETECTION ===
    function detectHeaderRow(sheet) {
      addLog("üîç Detectando cabe√ßalhos...", 'info');
      
      const range = XLSX.utils.decode_range(sheet['!ref']);
      columnMapping = {};
      
      const columnTypes = {
        'Prefixo': ['prefixo', 'prefix'],
        'Proposta': ['proposta', 'proposal', 'numero', 'n¬∫'],
        'Cliente': ['cliente', 'client', 'nome'],
        'Situa√ß√£o': ['situa√ß√£o', 'situacao', 'status'],
        'Depend√™ncia': ['depend√™ncia', 'dependencia', 'ag√™ncia', 'agencia'],
        'Valor': ['valor', 'value', 'total', 'montante'],
        'Estado': ['estado', 'uf'],
        'SuperComercial': ['super', 'comercial', 'supervisor']
      };
      
      for (let row = range.s.r; row <= Math.min(range.s.r + 10, range.e.r); row++) {
        let matchCount = 0;
        let found = {};
        
        for (let col = range.s.c; col <= range.e.c; col++) {
          const addr = XLSX.utils.encode_cell({ r: row, c: col });
          const cell = sheet[addr];
          
          if (cell && cell.v) {
            const value = String(cell.v).toLowerCase().trim();
            
            for (const [type, keywords] of Object.entries(columnTypes)) {
              if (keywords.some(kw => value.includes(kw))) {
                if (!found[type]) {
                  found[type] = cell.v;
                  matchCount++;
                }
              }
            }
          }
        }
        
        if (matchCount >= 4) {
          columnMapping = found;
          addLog(`‚úì Cabe√ßalho detectado na linha ${row + 1}`, 'success');
          return row;
        }
      }
      
      addLog("‚ö† Usando linha 2 como fallback", 'warning');
      return 1;
    }
    
    function getColumn(row, type) {
      if (columnMapping[type] && row[columnMapping[type]] !== undefined) {
        return row[columnMapping[type]];
      }
      return "";
    }
    
    function parseNumber(val) {
      if (!val) return 0;
      if (typeof val === "number") return val;
      const clean = String(val).replace(/\./g, "").replace(",", ".");
      const n = parseFloat(clean);
      return isNaN(n) ? 0 : n;
    }
    
    // === FILE PROCESSING ===
    const fileInput = document.getElementById("fileInput");
    
    fileInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      
      addLog(`üöÄ Processando ${files.length} arquivo(s)...`, 'info');
      
      datasets = [];
      proposalHistory = {};
      removedProposals = [];
      latestIndex = -1;
      latestRows = [];
      columnMapping = {};
      allColumns = [];
      
      for (const file of files) {
        try {
          addLog(`üìÑ ${file.name}`, 'info');
          const rows = await readXlsx(file);
          if (rows && rows.length) {
            datasets.push({ name: file.name, rows });
            addLog(`‚úì ${rows.length} linhas`, 'success');
          }
        } catch (err) {
          addLog(`‚úó Erro: ${err.message}`, 'error');
        }
      }
      
      if (!datasets.length) {
        addLog("‚úó Nenhuma planilha v√°lida", 'error');
        return;
      }
      
      latestIndex = datasets.length - 1;
      latestRows = datasets[latestIndex].rows || [];
      
      buildProposalHistory();
      computeRemovedProposals();
      detectAllColumns();
      initializeVisibleColumns();
      buildColumnSelector();
      buildFilters();
      applyFilters();
      
      addLog("‚úì Processamento conclu√≠do!", 'success');
      lucide.createIcons();
    });
    
    function readXlsx(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const headerRow = detectHeaderRow(sheet);
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: "", range: headerRow });
            resolve(rows);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }
    
    function buildProposalHistory() {
      proposalHistory = {};
      datasets.forEach((ds, dsIndex) => {
        (ds.rows || []).forEach((row) => {
          const proposta = String(getColumn(row, 'Proposta')).trim();
          if (!proposta) return;
          const situacao = String(getColumn(row, 'Situa√ß√£o')).trim();
          if (!proposalHistory[proposta]) proposalHistory[proposta] = [];
          proposalHistory[proposta].push({ dsIndex, row, situacao });
        });
      });
    }
    
    function computeRemovedProposals() {
      removedProposals = [];
      if (latestIndex < 0) return;
      
      Object.entries(proposalHistory).forEach(([proposta, history]) => {
        const existedBefore = history.some(h => h.dsIndex < latestIndex);
        const existsNow = history.some(h => h.dsIndex === latestIndex);
        
        if (existedBefore && !existsNow) {
          const lastPrev = history.filter(h => h.dsIndex < latestIndex).sort((a, b) => b.dsIndex - a.dsIndex)[0];
          removedProposals.push({ proposta, row: lastPrev.row });
        }
      });
    }
    
    function detectAllColumns() {
      allColumns = [];
      if (!latestRows.length) return;
      
      const firstRow = latestRows[0];
      allColumns = Object.keys(firstRow).filter(key => key.trim() !== "");
      addLog(`üìã ${allColumns.length} colunas detectadas`, 'info');
    }
    
    function initializeVisibleColumns() {
      visibleColumns = new Set(allColumns);
    }
    
    // === COLUMN SELECTOR ===
    function buildColumnSelector() {
      const selector = document.getElementById("columnSelector");
      selector.innerHTML = '';
      
      const selectAll = document.createElement('div');
      selectAll.className = 'checkbox-group';
      selectAll.style.borderBottom = '1px solid var(--border)';
      selectAll.style.marginBottom = '0.5rem';
      selectAll.style.fontWeight = '600';
      selectAll.innerHTML = `
        <input type="checkbox" id="selectAllCols" class="checkbox" checked />
        <label for="selectAllCols" style="cursor: pointer; flex: 1;">Selecionar Todas</label>
      `;
      selector.appendChild(selectAll);
      
      document.getElementById('selectAllCols').addEventListener('change', (e) => {
        if (e.target.checked) {
          visibleColumns = new Set(allColumns);
          document.querySelectorAll('.col-checkbox').forEach(cb => cb.checked = true);
        } else {
          visibleColumns.clear();
          document.querySelectorAll('.col-checkbox').forEach(cb => cb.checked = false);
        }
        applyFilters();
      });
      
      allColumns.forEach(col => {
        const div = document.createElement('div');
        div.className = 'checkbox-group';
        const id = `col_${col.replace(/\s+/g, '_')}`;
        div.innerHTML = `
          <input type="checkbox" id="${id}" class="checkbox col-checkbox" checked />
          <label for="${id}" style="cursor: pointer; flex: 1; font-size: 0.875rem;">${col}</label>
        `;
        selector.appendChild(div);
        
        div.querySelector('input').addEventListener('change', (e) => {
          if (e.target.checked) {
            visibleColumns.add(col);
          } else {
            visibleColumns.delete(col);
          }
          updateSelectAllCheckbox();
          applyFilters();
        });
      });
    }
    
    function updateSelectAllCheckbox() {
      const selectAll = document.getElementById('selectAllCols');
      if (selectAll) {
        selectAll.checked = visibleColumns.size === allColumns.length;
      }
    }
    
    // === FILTERS ===
    function buildFilters() {
      const container = document.getElementById("filtersContainer");
      container.innerHTML = '';
      columnFilters = {};
      
      allColumns.forEach(col => {
        const values = new Set();
        latestRows.forEach(row => {
          const val = row[col];
          if (val && String(val).trim()) values.add(String(val).trim());
        });
        
        if (values.size === 0) return;
        
        const div = document.createElement('div');
        div.innerHTML = `
          <label style="display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">
            ${col.toUpperCase()}
          </label>
          <select class="input filter-select" data-column="${col}">
            <option value="">Todos</option>
            ${Array.from(values).sort().map(v => `<option value="${v}">${v}</option>`).join('')}
          </select>
        `;
        container.appendChild(div);
        
        const select = div.querySelector('select');
        select.addEventListener('change', (e) => {
          columnFilters[col] = e.target.value;
          applyFilters();
        });
      });
      
      // Filtro especial para ag√™ncia
      const filterAgencia = document.getElementById('filterAgencia');
      const agencias = new Set();
      latestRows.forEach(row => {
        const dep = getColumn(row, 'Depend√™ncia');
        if (dep) agencias.add(dep);
      });
      
      filterAgencia.innerHTML = '<option value="">Todas as Ag√™ncias</option>';
      Array.from(agencias).sort().forEach(ag => {
        const opt = document.createElement('option');
        opt.value = ag;
        opt.textContent = ag;
        filterAgencia.appendChild(opt);
      });
      
      filterAgencia.addEventListener('change', applyFilters);
    }
    
    document.getElementById('clearFilters').addEventListener('click', () => {
      columnFilters = {};
      document.querySelectorAll('.filter-select').forEach(sel => sel.value = '');
      document.getElementById('filterAgencia').value = '';
      applyFilters();
    });
    
    function applyFilters() {
      if (!latestRows.length) return;
      
      const agenciaFilter = document.getElementById('filterAgencia').value;
      
      const filtered = latestRows.filter(row => {
        // Filtros por coluna
        for (const [col, filterVal] of Object.entries(columnFilters)) {
          if (filterVal && String(row[col]).trim() !== filterVal) return false;
        }
        
        // Filtro de ag√™ncia
        if (agenciaFilter) {
          const dep = getColumn(row, 'Depend√™ncia');
          if (dep !== agenciaFilter) return false;
        }
        
        return true;
      });
      
      const mode = document.getElementById('viewMode').value;
      if (mode === 'consolidated') {
        renderConsolidated(filtered);
      } else {
        renderTable(filtered);
      }
      
      updateStats(filtered);
      renderAgencias(filtered);
      renderSituacaoAgencia(filtered);
      renderRemovidas(filtered);
    }
    
    document.getElementById('viewMode').addEventListener('change', applyFilters);
    
    // === RENDERING ===
    function renderTable(rows) {
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      
      const visibleCols = allColumns.filter(col => visibleColumns.has(col));
      
      tableHead.innerHTML = visibleCols.map(col => `<th>${col}</th>`).join('') + '<th>Evolu√ß√£o</th>';
      tableBody.innerHTML = '';
      
      if (!rows.length) {
        tableBody.innerHTML = `<tr><td colspan="${visibleCols.length + 1}" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Nenhuma proposta encontrada</td></tr>`;
        return;
      }
      
      rows.forEach(row => {
        const tr = document.createElement('tr');
        
        visibleCols.forEach(col => {
          const td = document.createElement('td');
          const val = row[col];
          
          if (col.toLowerCase().includes('valor')) {
            td.style.textAlign = 'right';
            td.style.fontWeight = '700';
            td.textContent = parseNumber(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          } else {
            td.textContent = val || '-';
          }
          
          tr.appendChild(td);
        });
        
        // Evolu√ß√£o
        const tdEvol = document.createElement('td');
        const proposta = String(getColumn(row, 'Proposta')).trim();
        const sit = getColumn(row, 'Situa√ß√£o');
        const evolution = getEvolutionInfo(proposta, sit);
        
        if (evolution.type === 'nova') {
          tdEvol.innerHTML = '<span class="badge badge-success">Nova</span>';
        } else if (evolution.type === 'alterada') {
          tdEvol.innerHTML = `
            <div class="evolution-info">
              <span style="color: var(--text-secondary);">${evolution.previousSituacao}</span>
              <div class="evolution-arrow">
                <i data-lucide="arrow-down" style="width: 0.875rem; height: 0.875rem;"></i>
                ${evolution.currentSituacao}
              </div>
            </div>
          `;
        } else {
          tdEvol.innerHTML = '<span class="badge badge-warning">Mantida</span>';
        }
        
        tr.appendChild(tdEvol);
        tableBody.appendChild(tr);
      });
      
      lucide.createIcons();
    }
    
    function renderConsolidated(rows) {
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      
      tableHead.innerHTML = `
        <th>Ag√™ncia</th>
        <th style="text-align: center;">Quantidade</th>
        <th style="text-align: right;">Valor Total</th>
        <th style="text-align: center;">Novas</th>
        <th style="text-align: center;">Mantidas</th>
        <th style="text-align: center;">Alteradas</th>
      `;
      
      tableBody.innerHTML = '';
      
      const consolidated = {};
      rows.forEach(row => {
        const dep = getColumn(row, 'Depend√™ncia') || 'Sem identifica√ß√£o';
        const valor = parseNumber(getColumn(row, 'Valor'));
        const proposta = String(getColumn(row, 'Proposta')).trim();
        const sit = getColumn(row, 'Situa√ß√£o');
        
        if (!consolidated[dep]) {
          consolidated[dep] = { qtd: 0, valor: 0, novas: 0, mantidas: 0, alteradas: 0 };
        }
        
        consolidated[dep].qtd++;
        consolidated[dep].valor += valor;
        
        const evolution = getEvolutionInfo(proposta, sit);
        if (evolution.type === 'nova') consolidated[dep].novas++;
        else if (evolution.type === 'alterada') consolidated[dep].alteradas++;
        else consolidated[dep].mantidas++;
      });
      
      Object.entries(consolidated)
        .sort((a, b) => b[1].valor - a[1].valor)
        .forEach(([dep, data]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="font-weight: 600;">${dep}</td>
            <td style="text-align: center;"><span class="badge badge-info">${data.qtd}</span></td>
            <td style="text-align: right; font-weight: 700;">${data.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
            <td style="text-align: center;"><span class="badge badge-success">${data.novas}</span></td>
            <td style="text-align: center;"><span class="badge badge-warning">${data.mantidas}</span></td>
            <td style="text-align: center;"><span class="badge badge-info">${data.alteradas}</span></td>
          `;
          tableBody.appendChild(tr);
        });
    }
    
    function getEvolutionInfo(proposta, currentSituacao) {
      const hist = proposalHistory[proposta];
      if (!hist || !hist.length) return { type: 'nova', previousSituacao: null, currentSituacao };
      
      const previousVersions = hist.filter(h => h.dsIndex < latestIndex);
      if (!previousVersions.length) return { type: 'nova', previousSituacao: null, currentSituacao };
      
      const lastPrev = previousVersions.sort((a, b) => b.dsIndex - a.dsIndex)[0];
      const prevSit = lastPrev.situacao;
      
      if (prevSit !== currentSituacao && prevSit && currentSituacao) {
        return { type: 'alterada', previousSituacao: prevSit, currentSituacao };
      }
      
      return { type: 'mantida', previousSituacao: prevSit, currentSituacao };
    }
    
    function updateStats(rows) {
      const total = rows.length;
      const valor = rows.reduce((acc, row) => acc + parseNumber(getColumn(row, 'Valor')), 0);
      
      let novas = 0;
      rows.forEach(row => {
        const proposta = String(getColumn(row, 'Proposta')).trim();
        const sit = getColumn(row, 'Situa√ß√£o');
        const evolution = getEvolutionInfo(proposta, sit);
        if (evolution.type === 'nova') novas++;
      });
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statValor').textContent = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      document.getElementById('statNovas').textContent = novas;
      document.getElementById('statRemovidas').textContent = removedProposals.length;
    }
    
    function renderAgencias(rows) {
      const body = document.getElementById('agenciaBody');
      body.innerHTML = '';
      
      const map = {};
      rows.forEach(row => {
        const dep = getColumn(row, 'Depend√™ncia') || 'Sem identifica√ß√£o';
        const val = parseNumber(getColumn(row, 'Valor'));
        if (!map[dep]) map[dep] = { qtd: 0, valor: 0 };
        map[dep].qtd++;
        map[dep].valor += val;
      });
      
      Object.entries(map)
        .sort((a, b) => b[1].valor - a[1].valor)
        .forEach(([dep, data]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="font-weight: 600;">${dep}</td>
            <td style="text-align: center;"><span class="badge badge-info">${data.qtd}</span></td>
            <td style="text-align: right; font-weight: 700;">${data.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
          `;
          body.appendChild(tr);
        });
    }
    
    function renderSituacaoAgencia(rows) {
      const head = document.getElementById('situacaoAgenciaHead');
      const body = document.getElementById('situacaoAgenciaBody');
      
      head.innerHTML = '';
      body.innerHTML = '';
      
      if (!rows.length) return;
      
      const matrix = {};
      const situacoes = new Set();
      
      rows.forEach(row => {
        const dep = getColumn(row, 'Depend√™ncia') || 'Sem identifica√ß√£o';
        const sit = String(getColumn(row, 'Situa√ß√£o')).trim() || 'Sem situa√ß√£o';
        situacoes.add(sit);
        if (!matrix[dep]) matrix[dep] = {};
        if (!matrix[dep][sit]) matrix[dep][sit] = 0;
        matrix[dep][sit]++;
      });
      
      const sitArray = Array.from(situacoes).sort();
      
      let headHTML = '<tr><th>Ag√™ncia</th>';
      sitArray.forEach(sit => headHTML += `<th style="text-align: center; font-size: 0.7rem;">${sit}</th>`);
      headHTML += '<th style="text-align: center;">Total</th></tr>';
      head.innerHTML = headHTML;
      
      Object.entries(matrix).forEach(([dep, sits]) => {
        let total = 0;
        let rowHTML = `<tr><td style="font-weight: 600;">${dep}</td>`;
        sitArray.forEach(sit => {
          const count = sits[sit] || 0;
          total += count;
          rowHTML += `<td style="text-align: center;">${count || '-'}</td>`;
        });
        rowHTML += `<td style="text-align: center; font-weight: 700;">${total}</td></tr>`;
        body.innerHTML += rowHTML;
      });
    }
    
    function renderRemovidas(filteredRows) {
      const body = document.getElementById('removidasBody');
      body.innerHTML = '';
      
      removedProposals.slice(0, 50).forEach(({ proposta, row }) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight: 700; color: #dc2626;">${proposta}</td>
          <td>${getColumn(row, 'Cliente') || '-'}</td>
          <td style="text-align: right; font-weight: 700;">${parseNumber(getColumn(row, 'Valor')).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
        `;
        body.appendChild(tr);
      });
      
      if (!removedProposals.length) {
        body.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: var(--text-secondary);">Nenhuma proposta removida</td></tr>';
      }
    }
    
    // === EXPORT ===
    document.getElementById('btnExportCSV').addEventListener('click', () => {
      if (!latestRows.length) return;
      
      const agenciaFilter = document.getElementById('filterAgencia').value;
      const filtered = latestRows.filter(row => {
        for (const [col, filterVal] of Object.entries(columnFilters)) {
          if (filterVal && String(row[col]).trim() !== filterVal) return false;
        }
        if (agenciaFilter && getColumn(row, 'Depend√™ncia') !== agenciaFilter) return false;
        return true;
      });
      
      const visibleCols = allColumns.filter(col => visibleColumns.has(col));
      const header = [...visibleCols, 'Tipo Evolu√ß√£o', 'Situa√ß√£o Anterior'];
      const lines = [header.join(';')];
      
      filtered.forEach(row => {
        const proposta = String(getColumn(row, 'Proposta')).trim();
        const sit = getColumn(row, 'Situa√ß√£o');
        const evolution = getEvolutionInfo(proposta, sit);
        
        const values = visibleCols.map(col => {
          const val = row[col];
          return `"${String(val || '').replace(/"/g, '""')}"`;
        });
        
        values.push(`"${evolution.type}"`);
        values.push(`"${evolution.previousSituacao || ''}"`);
        
        lines.push(values.join(';'));
      });
      
      const blob = new Blob([lines.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'propostas.csv';
      a.click();
      URL.revokeObjectURL(url);
      
      addLog('‚úì CSV exportado', 'success');
    });
    
    document.getElementById('btnExportPNG').addEventListener('click', () => {
      addLog('üì∏ Gerando PNG...', 'info');
      html2canvas(document.body, { scale: 2 }).then(canvas => {
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'painel.png';
          a.click();
          URL.revokeObjectURL(url);
          addLog('‚úì PNG exportado', 'success');
        });
      });
    });
  </script>
</body>
</html>